<!doctype html>
<html>
  <head>
    <link href="/css/tweets_url.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <title>browser source</title>
    <style>
    	#tweet{display:none;}
    </style>
  </head>
  <body>
    <div id="tweet" class="w3-container">
      <div class="w3-card-4" style="width:20%;">
        <header class="w3-container w3-blue">
          <img src="" id="tweet-img" class="avatar">
          <img style="float: right;" class="twitter" alt="" src="https://pngimg.com/uploads/twitter/twitter_PNG1.png" />
          <p class="header full_name" id="tweet-author"><p class="header at" id="tweet-at"></p></p>
        </header>
        <div class="w3-container content  tweet-div">
          <p id="tweet-text" class="content"></p>
        </div>
      </div>
    </div>
  </body>
</html>

<script src="/socket.io/socket.io.js"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script>
  $(function () {
    var socket = io();
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const room = urlParams.get('room')

    socket.on(`tweetUrl-${room}`, function(tweets){
    	for (const tweet of tweets) {
    		$("#tweet").fadeOut(1000, function() {
    			$(`#tweet-text`).html( "");
          $(`#tweet-author`).html( "");
				  $.ajax({
            url: "https://publish.twitter.com/oembed?url=" + tweet,
            dataType: "jsonp",
            success: function(data) {
              
              new_html = data.html.replace(/<script.*?<\/script>/g, '');
              new_html = new_html.replace(/(\<a)(?!.*\<a).*<\/a>/, "");
              new_html = new_html.replace(/<blockquote .*?>/g, '');
              new_html = new_html.replace(/<\/blockquote>.*?/g, '');
              text = new_html.split('&mdash;')[0]
              text = text.split('pic.twitter')[0]
              author = new_html.split('&mdash;')[1]
              at = author.match(/\(([^)]+)\)/)[1]
              image = `http://twivatar.glitch.me/${at.substring(1)}`
              $(`#tweet-text`).html(text);
              $(`#tweet-author`).html(author.replace(`(${at})`,''));
              $(`#tweet-at`).html(at);
              $(`#tweet-img`).attr("src", image);
            }
          });
				}).fadeIn(1000).delay(4000).fadeOut(500).delay(1000);
      };
    });
  });
</script>

<style>
  .w3-blue, .w3-hover-blue:hover {
    background-color: #6d636c!important;
  }

  p.header {
    margin-top: 10px;
    line-height: 10px;   /* within paragraph */
    margin-bottom: 10px; /* between paragraphs */
  }

  a {
    color: #ff929b;
  }

  img.avatar {
    border-radius: 50%;
    width: 50px;
    float: left;
    margin-left: -10px;
    margin-right: 10px;
    margin-top: 5px;
  }
</style>